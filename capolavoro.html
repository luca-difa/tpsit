<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Platformer Avanzato con Livelli Vari</title>
<style>
  body {
    margin: 0;
    background: linear-gradient(#87ceeb, #f0f8ff);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    user-select: none;
  }
  canvas {
    display: block;
    margin: 20px auto;
    background: #70c5ff;
    border: 5px solid #34495e;
    border-radius: 14px;
    box-shadow: 0 0 20px #34495eaa;
  }
  #info {
    text-align: center;
    font-weight: bold;
    font-size: 22px;
    color: #222;
    text-shadow: 1px 1px 3px white;
    margin-top: 5px;
  }
</style>
</head>
<body>
<div id="info">Punteggio: 0 | Vita: 3 | Livello: 1</div>
<canvas id="gameCanvas" width="900" height="520"></canvas>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;

  // Fisica
  const gravity = 0.7;
  const friction = 0.85;

  // Audio beep (Web Audio API)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playBeep(freq=600, duration=0.1) {
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.type = 'square';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  // Player classe
  class Player {
    constructor() {
      this.width = 40;
      this.height = 60;
      this.x = 50;
      this.y = HEIGHT - this.height - 40;
      this.velX = 0;
      this.velY = 0;
      this.speed = 5;
      this.jumping = false;
      this.grounded = false;
      this.lives = 3;
      this.score = 0;
      this.colorPhase = 0;
      this.jumpPower = 15; // salta più alto in livelli avanzati
      this.isPowered = false;
      this.powerTimer = 0;
    }

    draw() {
      if (Math.abs(this.velX) > 0.1 && this.grounded) {
        this.colorPhase += 0.15;
      } else {
        this.colorPhase = 0;
      }
      const blueShade = 150 + Math.sin(this.colorPhase) * 50;
      const baseColor = `rgb(40, 80, ${Math.floor(blueShade)})`;
      const poweredColor = `rgb(255, 215, 0)`; // oro se power-up attivo
      ctx.fillStyle = this.isPowered ? poweredColor : baseColor;
      ctx.shadowColor = this.isPowered ? "gold" : "transparent";
      ctx.shadowBlur = this.isPowered ? 15 : 0;
      ctx.fillRect(this.x, this.y, this.width, this.height);

      // Occhi
      ctx.shadowBlur = 0;
      ctx.fillStyle = 'white';
      ctx.fillRect(this.x + 10, this.y + 15, 10, 10);
      ctx.fillRect(this.x + 20, this.y + 15, 10, 10);
      ctx.fillStyle = 'black';
      ctx.fillRect(this.x + 14, this.y + 18, 4, 4);
      ctx.fillRect(this.x + 24, this.y + 18, 4, 4);
    }

    update() {
      this.velX *= friction;
      this.velY += gravity;

      this.x += this.velX;
      this.y += this.velY;

      if (this.x < 0) this.x = 0;
      if (this.x + this.width > WIDTH) this.x = WIDTH - this.width;

      if (this.y > HEIGHT) {
        this.lives--;
        resetPlayer();
      }

      if (this.isPowered) {
        this.powerTimer--;
        if (this.powerTimer <= 0) {
          this.isPowered = false;
          this.jumpPower = 15;
        }
      }
    }

    powerUpJump() {
      this.isPowered = true;
      this.jumpPower = 22;
      this.powerTimer = 600; // dura 600 frame (~10 secondi a 60fps)
    }
  }

  // Piattaforma base
  class Platform {
    constructor(x, y, w, h) {
      this.x = x;
      this.y = y;
      this.width = w;
      this.height = h;
      this.color = '#2c3e50';
      this.shadowColor = 'rgba(0,0,0,0.3)';
    }
    draw() {
      ctx.fillStyle = this.shadowColor;
      ctx.fillRect(this.x + 4, this.y + 4, this.width, this.height);
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, this.width, this.height);
      ctx.strokeStyle = '#34495e';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(this.x, this.y + this.height/2);
      ctx.lineTo(this.x + this.width, this.y + this.height/2);
      ctx.stroke();
    }
  }

  // Piattaforma mobile orizzontale (per livelli avanzati)
  class MovingPlatform extends Platform {
    constructor(x, y, w, h, range, speed) {
      super(x, y, w, h);
      this.startX = x;
      this.range = range;
      this.speed = speed;
      this.direction = 1;
      this.color = '#2980b9';
      this.shadowColor = 'rgba(0,0,50,0.3)';
    }
    update() {
      this.x += this.speed * this.direction;
      if (this.x > this.startX + this.range || this.x < this.startX) {
        this.direction *= -1;
      }
    }
  }

  // Moneta base
  class Coin {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.radius = 10;
      this.collected = false;
      this.color = 'gold';
      this.bounce = 0;
    }
    draw() {
      if (this.collected) return;
      this.bounce += 0.1;
      const bounceHeight = Math.sin(this.bounce) * 5;
      ctx.beginPath();
      ctx.ellipse(this.x + 5, this.y + bounceHeight + 12, this.radius, this.radius / 3, 0, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(0,0,0,0.15)';
      ctx.fill();
      ctx.closePath();
      ctx.beginPath();
      ctx.arc(this.x, this.y + bounceHeight, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.closePath();
    }
  }

  // Moneta speciale: dà vita extra
  class LifeCoin extends Coin {
    constructor(x, y) {
      super(x, y);
      this.color = 'red';
    }
    draw() {
      if (this.collected) return;
      this.bounce += 0.12;
      const bounceHeight = Math.sin(this.bounce) * 6;
      ctx.beginPath();
      ctx.ellipse(this.x + 5, this.y + bounceHeight + 12, this.radius, this.radius / 3, 0, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(50,0,0,0.3)';
      ctx.fill();
      ctx.closePath();
      ctx.beginPath();
      ctx.arc(this.x, this.y + bounceHeight, this.radius, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.strokeStyle = '#ff6666';
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.closePath();
      // Cuoricino al centro
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('❤', this.x, this.y + bounceHeight + 6);
    }
  }

  // PowerUp salto alto
  class JumpPowerUp {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.size = 20;
      this.collected = false;
      this.color = '#27ae60';
      this.bounce = 0;
    }
    draw() {
      if (this.collected) return;
      this.bounce += 0.1;
      const bounceHeight = Math.sin(this.bounce) * 4;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.moveTo(this.x, this.y + bounceHeight);
      ctx.lineTo(this.x + this.size / 2, this.y + this.size + bounceHeight);
      ctx.lineTo(this.x - this.size / 2, this.y + this.size + bounceHeight);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = '#145a32';
      ctx.lineWidth = 2;
      ctx.stroke();
    }
  }

  // Nemico base
  class Enemy {
    constructor(x, y, w, h, range, speed=2) {
      this.x = x;
      this.y = y;
      this.width = w;
      this.height = h;
      this.color = '#c0392b';
      this.range = range;
      this.startX = x;
      this.speed = speed;
      this.direction = 1;
      this.originalY = y;
      this.vertical = false;
      this.verticalRange = 0;
      this.verticalDirection = 1;
    }
    draw() {
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, this.width, this.height);

      // Occhi
      ctx.fillStyle = 'white';
      ctx.fillRect(this.x + 5, this.y + 10, 10, 10);
      ctx.fillRect(this.x + this.width - 15, this.y + 10, 10, 10);
      ctx.fillStyle = 'black';
      ctx.fillRect(this.x + 8, this.y + 13, 4, 4);
      ctx.fillRect(this.x + this.width - 12, this.y + 13, 4, 4);
    }
    update() {
      if (!this.vertical) {
        this.x += this.speed * this.direction;
        if (this.x > this.startX + this.range || this.x < this.startX) {
          this.direction *= -1;
        }
      } else {
        this.y += this.speed * this.verticalDirection;
        if (this.y > this.originalY + this.verticalRange || this.y < this.originalY) {
          this.verticalDirection *= -1;
        }
      }
    }
  }

  // Nemico verticale (più difficile)
  class VerticalEnemy extends Enemy {
    constructor(x, y, w, h, verticalRange, speed=2) {
      super(x, y, w, h, 0, speed);
      this.vertical = true;
      this.verticalRange = verticalRange;
    }
  }

  // Nuvole animate
  class Cloud {
    constructor(x, y, scale=1) {
      this.x = x;
      this.y = y;
      this.scale = scale;
      this.speed = 0.3 * scale;
    }
    draw() {
      this.x += this.speed;
      if (this.x > WIDTH + 100) this.x = -150;
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      ctx.beginPath();
      // Nuvola composta da 3 cerchi
      ctx.arc(this.x, this.y, 20 * this.scale, Math.PI * 0.5, Math.PI * 1.5);
      ctx.arc(this.x + 30 * this.scale, this.y - 10 * this.scale, 25 * this.scale, Math.PI * 1, Math.PI * 1.85);
      ctx.arc(this.x + 60 * this.scale, this.y, 20 * this.scale, Math.PI * 1.5, Math.PI * 0.5);
      ctx.closePath();
      ctx.fill();
    }
  }

  // Setup iniziale
  const player = new Player();

  let keys = {};
  document.addEventListener('keydown', (e) => {
    keys[e.code] = true;
    if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') e.preventDefault();
  });
  document.addEventListener('keyup', (e) => {
    keys[e.code] = false;
  });

  // Livelli
  const levels = [
    {
      // Livello 1: base semplice
      platforms: [
        new Platform(0, HEIGHT - 30, WIDTH, 30),
        new Platform(100, 400, 120, 20),
        new Platform(300, 350, 120, 20),
        new Platform(520, 370, 150, 20),
        new Platform(730, 300, 130, 20),
      ],
      coins: [
        new Coin(130, 370),
        new Coin(340, 320),
        new Coin(560, 340),
        new Coin(770, 270),
      ],
      enemies: [
        new Enemy(200, HEIGHT - 90, 40, 50, 100, 2),
      ],
      lifeCoins: [],
      powerUps: []
    },
    {
      // Livello 2: piattaforme mobili e monete vita
      platforms: [
        new Platform(0, HEIGHT - 30, WIDTH, 30),
        new MovingPlatform(200, 430, 150, 20, 180, 2),
        new Platform(600, 380, 130, 20),
        new MovingPlatform(400, 320, 120, 20, 130, 1.5),
      ],
      coins: [
        new Coin(230, 400),
        new Coin(650, 350),
      ],
      enemies: [
        new Enemy(500, HEIGHT - 90, 40, 50, 150, 3),
        new Enemy(100, HEIGHT - 90, 40, 50, 90, 2),
      ],
      lifeCoins: [
        new LifeCoin(610, 340),
      ],
      powerUps: []
    },
    {
      // Livello 3: nemici verticali e power-up salto alto
      platforms: [
        new Platform(0, HEIGHT - 30, WIDTH, 30),
        new Platform(120, 400, 100, 20),
        new Platform(280, 360, 120, 20),
        new MovingPlatform(450, 300, 160, 20, 200, 2.2),
        new Platform(700, 260, 150, 20),
      ],
      coins: [
        new Coin(150, 370),
        new Coin(320, 330),
        new Coin(770, 230),
      ],
      enemies: [
        new VerticalEnemy(600, 320, 40, 50, 80, 2.5),
        new Enemy(200, HEIGHT - 90, 40, 50, 120, 2),
      ],
      lifeCoins: [],
      powerUps: [
        new JumpPowerUp(460, 270),
      ]
    },
    {
      // Livello 4: difficile con tutte le meccaniche
      platforms: [
        new Platform(0, HEIGHT - 30, WIDTH, 30),
        new MovingPlatform(150, 420, 140, 20, 170, 2),
        new MovingPlatform(370, 380, 120, 20, 140, 1.8),
        new Platform(550, 330, 130, 20),
        new MovingPlatform(750, 280, 140, 20, 160, 2.5),
      ],
      coins: [
        new Coin(180, 390),
        new Coin(400, 350),
        new Coin(580, 300),
        new Coin(800, 250),
      ],
      enemies: [
        new VerticalEnemy(520, 320, 40, 50, 70, 3),
        new Enemy(250, HEIGHT - 90, 40, 50, 140, 3),
        new Enemy(700, HEIGHT - 90, 40, 50, 130, 2.5),
      ],
      lifeCoins: [
        new LifeCoin(790, 240),
      ],
      powerUps: [
        new JumpPowerUp(380, 350),
      ]
    },
  ];

  let currentLevel = 0;

  // Nuvole per sfondo
  const clouds = [
    new Cloud(50, 50, 1),
    new Cloud(200, 80, 0.8),
    new Cloud(450, 40, 1.2),
    new Cloud(700, 90, 0.7),
    new Cloud(820, 70, 1),
  ];

  // UI Info
  const info = document.getElementById('info');

  // Reset player posizione e stato
  function resetPlayer() {
    player.x = 50;
    player.y = HEIGHT - player.height - 40;
    player.velX = 0;
    player.velY = 0;
    player.jumping = false;
    player.grounded = false;
    player.isPowered = false;
    player.jumpPower = 15;
    player.powerTimer = 0;
  }

  // Collisione rettangoli semplice
  function rectCollision(r1, r2) {
    return !(r2.x > r1.x + r1.width ||
             r2.x + r2.width < r1.x ||
             r2.y > r1.y + r1.height ||
             r2.y + r2.height < r1.y);
  }

  // Controllo collisione player con piattaforme (incluso piattaforme mobili)
  function checkPlatformCollision(platform) {
    if (player.velY >= 0) {
      if (player.x < platform.x + platform.width &&
          player.x + player.width > platform.x &&
          player.y + player.height <= platform.y + player.velY &&
          player.y + player.height + player.velY >= platform.y) {
        player.y = platform.y - player.height;
        player.velY = 0;
        player.jumping = false;
        player.grounded = true;
        return true;
      }
    }
    return false;
  }

  function update() {
    // Muovi piattaforme mobili
    for(let p of levels[currentLevel].platforms) {
      if (p instanceof MovingPlatform) p.update();
    }

    player.update();

    player.grounded = false;
    for(let plat of levels[currentLevel].platforms) {
      if (checkPlatformCollision(plat)) {
        player.grounded = true;
      }
    }

    if (player.grounded === false) {
      player.jumping = true;
    }

    // Movimento orizzontale
    if (keys['ArrowRight'] || keys['KeyD']) {
      if (player.velX < player.speed) {
        player.velX++;
      }
    } else if (keys['ArrowLeft'] || keys['KeyA']) {
      if (player.velX > -player.speed) {
        player.velX--;
      }
    }

    // Salto
    if ((keys['Space'] || keys['ArrowUp'] || keys['KeyW']) && !player.jumping && player.grounded) {
      player.velY = -player.jumpPower;
      player.jumping = true;
      player.grounded = false;
      playBeep(700, 0.15);
    }

    // Collisione monete
    for(let coin of levels[currentLevel].coins) {
      if (!coin.collected) {
        const distX = Math.abs((coin.x) - (player.x + player.width/2));
        const distY = Math.abs((coin.y) - (player.y + player.height/2));
        if (distX < 25 && distY < 35) {
          coin.collected = true;
          player.score += 10;
          playBeep(800, 0.1);
        }
      }
    }

    // Collisione monete vita
    for(let lifeCoin of levels[currentLevel].lifeCoins) {
      if (!lifeCoin.collected) {
        const distX = Math.abs((lifeCoin.x) - (player.x + player.width/2));
        const distY = Math.abs((lifeCoin.y) - (player.y + player.height/2));
        if (distX < 25 && distY < 35) {
          lifeCoin.collected = true;
          player.lives++;
          playBeep(1000, 0.15);
        }
      }
    }

    // Collisione power-up salto alto
    for(let powerUp of levels[currentLevel].powerUps) {
      if (!powerUp.collected) {
        const distX = Math.abs((powerUp.x) - (player.x + player.width/2));
        const distY = Math.abs((powerUp.y) - (player.y + player.height/2));
        if (distX < 25 && distY < 35) {
          powerUp.collected = true;
          player.powerUpJump();
          playBeep(1200, 0.2);
        }
      }
    }

    // Nemici update e collisione
    for(let enemy of levels[currentLevel].enemies) {
      enemy.update();
      if (rectCollision(player, enemy)) {
        // Se il player cade sopra il nemico lo uccide
        if (player.velY > 0 && (player.y + player.height - enemy.y) < 15) {
          // Elimina nemico (rimuoviamo semplicemente mettendo range a 0 e fuori schermo)
          enemy.x = -5000;
          enemy.y = -5000;
          player.velY = -player.jumpPower / 2;
          player.score += 20;
          playBeep(1500, 0.12);
        } else {
          // Player perde vita e reset posizione
          player.lives--;
          resetPlayer();
          playBeep(400, 0.3);
          if (player.lives <= 0) {
            alert("Game Over! Hai perso tutte le vite!");
            // Reset tutto
            player.score = 0;
            player.lives = 3;
            currentLevel = 0;
            for(let lvl of levels) {
              for(let c of lvl.coins) c.collected = false;
              for(let lc of lvl.lifeCoins) lc.collected = false;
              for(let pu of lvl.powerUps) pu.collected = false;
            }
          }
        }
      }
    }

    // Controllo fine livello (tutte monete raccolte)
    const allCollected = levels[currentLevel].coins.every(c => c.collected);
    if (allCollected) {
      currentLevel++;
      if (currentLevel >= levels.length) {
        alert("Complimenti! Hai finito tutti i livelli!");
        currentLevel = 0;
        player.score = 0;
        player.lives = 3;
        for(let lvl of levels) {
          for(let c of lvl.coins) c.collected = false;
          for(let lc of lvl.lifeCoins) lc.collected = false;
          for(let pu of lvl.powerUps) pu.collected = false;
        }
      }
      resetPlayer();
    }

    // Aggiorna info schermo
    info.textContent = `Punteggio: ${player.score} | Vita: ${player.lives} | Livello: ${currentLevel + 1}`;
  }

  function draw() {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);

    // Sfondo cielo con gradiente
    const gradient = ctx.createLinearGradient(0, 0, 0, HEIGHT);
    gradient.addColorStop(0, '#87ceeb');
    gradient.addColorStop(1, '#f0f8ff');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, WIDTH, HEIGHT);

    // Nuvole
    for(let cloud of clouds) cloud.draw();

    // Piattaforme
    for(let p of levels[currentLevel].platforms) p.draw();

    // Monete
    for(let coin of levels[currentLevel].coins) coin.draw();

    // Monete vita
    for(let lifeCoin of levels[currentLevel].lifeCoins) lifeCoin.draw();

    // Power-up salto alto
    for(let pu of levels[currentLevel].powerUps) pu.draw();

    // Nemici
    for(let enemy of levels[currentLevel].enemies) enemy.draw();

    // Player
    player.draw();
  }

  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  resetPlayer();
  gameLoop();
})();
</script>
</body>
</html>
